#### WIL NODE WITH BOOK

> KEYWORD

- 익스프레스의 핵심인 요청과 응답의 중간에 위치한 미들웨어에 대해서 알아보자

> SUMMARY

#### 작성 순서

1. app 생성 및 set으로 설정
2. app.use에 공통 미들웨어 넣어주기
3. 순서대로 라우터들 넣어주기(범위가 넒은 건 뒤로)
4. 마지막에 에러 미들웨어 넣기

#### 미들웨어

> - `미들웨어`는 **요청과 응답을 조작하여 기능을 추가**하기도 하고, **나쁜 요청을 걸러내기**도 함

- `미들웨어`는 **app.use와 함께 사용되며 `app.use(미들웨어)` 형태**이다. - app.use에 매개변수가 req, res, next인 함수를 넣고 미들웨어는 위에서부터 아래로 순서대로 실행되면서 요청과 응답 사이에 특별한 기능을 추가가능 - 이번에는 next라는 세 번째 매개변수를 사용했는데, 이는 다음 미들웨어로 넘어가는 함수이다. - next를 실행하지 않으면 다음 미들웨어가 실행되지 않는다. - 주소를 첫 번째 인수로 넣어주지 않는다면 미들웨어는 모든 요청에서 실행되고, 주소를 넣는다면 해당하는 요청에서만 실행된다.
  ![](https://images.velog.io/images/minj9_6/post/d5d13baf-1546-46dc-ac39-a472bf3386f9/image.png)

#### route parameter(혹은 와일드카드)

> - `app.get("/routeName/:변수명, ...)`처럼 라우트에 전달하면 req.params을 받을 수 있다.

- EX> 카테고리 별로 만들고싶을땐 route parameter에 변수를 사용할 수 있다.
- 미들웨어는 위에서 부터 아래로 실행되므로 라우트 파라미터는 다른 미들웨어 보다는 아래에 작성해줘야한다. (순서에 주의가 필요)
- _, asterisk처리를 하면 `app.get("_", ...)`처럼 모든 get요청에 대해 어떠한 주소든지 다 처리하겠다는 것을 의미
- 따라서 와일드 카드와 범위가 넒은 라우터들은 밑에 넣어주는게 좋다.

#### 에러 처리 미들웨어

> - 에러 처리 미들웨어는 **매개변수가 err, req, res, next**로 네 개로, 모든 매개변수를 사용하지 않더라도 **매개변수가 반드시 네 개**여야 함.

- 첫 번째 매개변수 err에는 에러에 관한 정보가 담겨 있다.
- res.status 메서드로 HTTP 상태 코드를 지정할 수 있고 기본값은 200(성공)이다
- 에러 처리 미들웨어를 직접 연결하지 않아도 기본적으로 익스프레스가 에러를 처리하지만 실무에서는 직접 에러 처리 미들웨어를 연결해주는 것이 좋다.
- 에러 처리 미들웨어는 특별한 경우가 아니면 가장 아래에 위치하는게 좋다
- 마지막 라우터 뒤에 404를 처리하는 미들웨어를 넣기도한다. 이때 status code를 커스텀 할 수 있다.

####💡주의) 실수하기 쉬운 부분

- 한 라우터에서 res.send(또는 res.json)를 2번 이상 하는 경우
  - 반드시 요청 한번에는 응답 한 번임을 기억
- res.json은 응답을 json 형태로 보낼 뿐이지 리턴이 아니다.
- res.render 역시 응답을 보내주는 것

#### next 활용법

- 에러를 throw로 하기 보단 try-catch내에서 catch블록 내부에 next로 에러를 넘겨준다.
- next에 인수가 있으면 다음 미들웨어가 아닌 에러처리 미들웨어로 넘어간다.
- next 인수에 'route'를 넘기면 같은 라우터에 다른 미들웨어가 실행되는 것이 아니라 다음 라우터로 넘어간다. 즉 next('route')는 같은 라우터 내에 있는 미들웨어를 건너띈다.
  - 보통 실무에서 if 문과 함께 사용해 어떤 미들웨어를 실행할 건지 설정하곤 한다. 즉 next 분기 처리를 통해 다음 미들웨어로 어떻게 넘어갈지 컨트롤 할 수 있다.
